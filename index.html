<!DOCTYPE html>
<html>
  <head>
    <script src="jquery.js"></script>
    <script src="moment.js"></script>
    <script src="data_generator.js"></script>
    <style>
      body{
        font-family: "Helvetica Neue",Helvetica,Arial,sans-serif;
        background-size: 100%;
        background-color: #B9DFEF;
      }

      .main{
        position: relative;
        width: 800px;
        display: block;
        margin: 0 auto;
        background-color: white;
        overflow: hidden;
      }

      .newTweetsContainer{
        text-align: center;   
        height: 20px; 
        background-color: #F5F8FA;
        color: #0084B4;
        cursor: pointer;
        border-bottom: 3px solid #B9DFEF;
        display: none;
        padding: 10px;
      }

      .tweetContainer{
        height: 52px;
        border-bottom: 3px solid #B9DFEF;
        padding: 6px;
        line-height: 25px;
      }

      .tweetUser{
        font-weight: bold;
        line-height: 20px;
        display: inline-block;
      } 

      .tweetUser:hover{
        color: #0084B4;
      }

      .tweetTimestamp{
        display: inline-block;
        margin-left: 5px;
        color: #8899a6;
        font-size: 13px;
      }

    </style>
  </head>
  <body>

    <script>

      $(document).ready(function(){

        moment().format();

        var $body = $('body');
        $body.html('');

        // set up the main container
        var $main = $('<div class="main"></div>');
        $main.appendTo($body);
        
        // set up the 'show new tweets' container
        var totalCount = 0;
        var interval;
        var $showNewTweet = $('<div class="newTweetsContainer"></div>');
        $showNewTweet.appendTo($main);

        // utility function for creating a new tweet container
        var $tweetContainer;
        var $tweetHeader;
        var $tweetContent;
        var $tweetUser;
        var $tweetTimestamp;
        var createTweetContainer = function(){
          $tweetContainer = $('<div class="tweetContainer"></div>');
          $tweetHeader = $('<div class="tweetHeader"></div>');
          $tweetContent = $('<div class="tweetContent"></div>');
          $tweetUser = $('<div class="tweetUser"></div>');
          $tweetTimestamp = $('<div class="tweetTimestamp"></div>');
          $tweetHeader.appendTo($tweetContainer);          
          $tweetContent.appendTo($tweetContainer);
          $tweetUser.appendTo($tweetHeader);
          $tweetTimestamp.appendTo($tweetHeader);
        };

        // check for new tweets
        var checkTweets = function(arr){
          interval = setInterval(function(){
            var currentCount = arr.length - totalCount;
            if(currentCount > 0){
                $showNewTweet.text('View ' + currentCount + ' new Tweets');
                $showNewTweet.slideDown();
              }

              $('.main').on('click', '.newTweetsContainer', function(){
                var index = totalCount;
                for(var i=0; i<currentCount; i++){
                  createTweetContainer();
                  var tweet = arr[index];
                  console.log(tweet);
                  $tweetUser.text(tweet.user);
                  $tweetTimestamp.text(' · ' + moment(tweet.created_at).format('MMM DD hh:mm A'));
                  $tweetContent.text('@' + tweet.user + ': ' + tweet.message);
                  $showNewTweet.after($tweetContainer);
                  index += 1;
                  totalCount++; 
                } 
                $showNewTweet.slideUp(); 
            }); 
          }, 5000);
        };

        // utility function for clearing interval
        function stopInterval() {
          clearInterval(interval);
        }

        // generate tweets on page load
        var index = streams.home.length - 1;
        while(index >= 0){    
          createTweetContainer();
          var tweet = streams.home[index];
          $tweetUser.text(tweet.user);
          $tweetTimestamp.text(' · ' + moment(tweet.created_at).format('MMM DD hh:mm A'));
          $tweetContent.text('@' + tweet.user + ': ' + tweet.message);
          $tweetContainer.appendTo($main);
          index -= 1;
          totalCount++;
        }
        checkTweets(streams.home);

        // allow user to click on a username to see that user's timeline.
        $('.main').on('click', '.tweetUser', function(){
          stopInterval();
          $('.tweetContainer').remove();
          totalCount = 0;
          var selectedUser = $(this).text();
          var $selectedArr = streams.users[selectedUser];
          var userIndex = streams.users[selectedUser].length - 1;
          while(userIndex >= 0){
            createTweetContainer();
            var tweet = streams.users[selectedUser][userIndex];
            $tweetUser.text(tweet.user);
            $tweetTimestamp.text(' · ' + moment(tweet.created_at).format('MMM DD hh:mm A'));
            $tweetContent.text('@' + tweet.user + ': ' + tweet.message);
            $tweetContainer.appendTo($main);
            userIndex -= 1;
            totalCount++;
          }
          checkTweets($selectedArr);
        });

      });

    </script>
      
  </body>
</html>
