<!DOCTYPE html>
<html>
  <head>
    <script src="jquery.js"></script>
    <script src="moment.js"></script>
    <script src="data_generator.js"></script>
    <link rel="stylesheet" type="text/css" href="style.css">
  </head>
  <body>
    <script>

      $(document).ready(function(){

        moment().format();

        var $body = $('body');
        $body.html('');
        var $header = $('<div class="header"></div>');
        $header.appendTo($body);
        var $logo = $('<div id="logo">Twittler</h1>');
        $logo.appendTo($header);
        var $content = $('<div class="content"></div>');
        $content.appendTo($body);
        var $container = $('<div class="container"></div>');
        $container.appendTo($content);
        var $newTweetsContainer = $('<div class="newTweetsContainer"></div>');
        $newTweetsContainer.appendTo($container);

        var totalCount = 0;
        var interval;
        var $selectedUser;

        // utility function for creating a new tweet container
        var $tweetContainer;
        var $tweetHeader;
        var $tweetContent;
        var $tweetUser;
        var $tweetTimestamp;
        var createTweetContainer = function(){
          $tweetContainer = $('<div class="tweetContainer"></div>');
          $tweetHeader = $('<div class="tweetHeader"></div>');
          $tweetContent = $('<div class="tweetContent"></div>');
          $tweetUser = $('<div class="tweetUser"></div>');
          $tweetTimestamp = $('<div class="tweetTimestamp"></div>');
          $tweetHeader.appendTo($tweetContainer);          
          $tweetContent.appendTo($tweetContainer);
          $tweetUser.appendTo($tweetHeader);
          $tweetTimestamp.appendTo($tweetHeader);
        };

        // set interval for checking new tweets
        var checkTweets = function(arr){
          interval = setInterval(function(){
            var arrLength = arr.length;
            var newTweet = arrLength - totalCount;
            if(newTweet > 0){
                $newTweetsContainer.text('View ' + newTweet + ' new Tweets');
                $newTweetsContainer.slideDown();
            }
          }, 5000);
        };

        // show new tweets on click
        $('.container').on('click', '.newTweetsContainer', function(){
          if(selectedUser === "home"){
            var arrLength = streams.home.length;
          }else{
            var arrLength = streams.users[selectedUser].length;
          }
          var newTweet = arrLength - totalCount;
          for(var i=0; i<newTweet; i++){
            if(selectedUser === "home"){
              var tweet = streams.home[totalCount];
            }else{
              var tweet = streams.users[selectedUser][totalCount];
            }
            createTweetContainer();
            $tweetUser.text(tweet.user);
            $tweetTimestamp.text(' · ' + moment(tweet.created_at).format('MMM DD hh:mm A'));
            $tweetContent.text('@' + tweet.user + ': ' + tweet.message);
            $newTweetsContainer.after($tweetContainer);
            totalCount++; 
          } 
          $newTweetsContainer.slideUp();
        }); 

        // utility function for clearing interval
        function stopInterval() {
          clearInterval(interval);
        }

        // generate tweets on page load
        var loadTweets = function(){
          selectedUser = "home";
          var index = streams.home.length - 1;
          while(index >= 0){    
            createTweetContainer();
            var tweet = streams.home[index];
            $tweetUser.text(tweet.user);
            $tweetTimestamp.text(' · ' + moment(tweet.created_at).format('MMM DD hh:mm A'));
            $tweetContent.text('@' + tweet.user + ': ' + tweet.message);
            $tweetContainer.appendTo($container);
            index -= 1;
            totalCount++;
          }
          checkTweets(streams.home);
        };

        loadTweets();

        // allow user to click on a username to see that user's timeline.
        $('.container').on('click', '.tweetUser', function(){
          stopInterval();
          $newTweetsContainer.slideUp(); 
          $('.tweetContainer').remove();
          totalCount = 0;
          selectedUser = $(this).text();
          var $selectedArr = streams.users[selectedUser];
          var userIndex = streams.users[selectedUser].length - 1;
          while(userIndex >= 0){
            createTweetContainer();
            var tweet = streams.users[selectedUser][userIndex];
            $tweetUser.text(tweet.user);
            $tweetTimestamp.text(' · ' + moment(tweet.created_at).format('MMM DD hh:mm A'));
            $tweetContent.text('@' + tweet.user + ': ' + tweet.message);
            $tweetContainer.appendTo($container);
            userIndex -= 1;
            totalCount++;
          }
          checkTweets($selectedArr);
        });

        // allow user to click on the logo to see tweets from all users
        $('.header').on('click', '#logo', function(){
          stopInterval();
          $('.tweetContainer').remove();
          totalCount = 0;
          loadTweets();
        });

      });

    </script>
  </body>
</html>
